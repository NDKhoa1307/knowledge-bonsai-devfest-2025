name: Backend deployment to Cloud Run
on:
  push:
    branches:
      - main
      - feat/backend-deployment
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yaml'
env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  ARTIFACT_REGISTRY_REPO: ${{ secrets.ARTIFACT_REGISTRY_REPO }}
  IMAGE_NAME: ${{ secrets.BACKEND_IMAGE_NAME }}
  SERVICE_NAME: ${{ secrets.BACKEND_SERVICE_NAME }}
  IMAGE_TAG: ${{ github.sha }}
jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        id: 'auth-gcloud'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure Docker 
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
      
      - name: Build and Tag Image
        run: |
          BE_FULL_IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}"
          echo "BE_FULL_IMAGE_PATH=$BE_FULL_IMAGE_PATH" >> $GITHUB_ENV
          docker build -t "$BE_FULL_IMAGE_PATH" ./backend
      
      - name: Push Image to Artifact Registry
        run: |
          docker push "$BE_FULL_IMAGE_PATH"
      
      - name: Install Cloud SQL Proxy and PostgreSQL Client
        run: |
          # Install Cloud SQL Proxy
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          sudo mv cloud-sql-proxy /usr/local/bin/
          
          # Install PostgreSQL client for pg_isready
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Start Cloud SQL Proxy
        run: |
          cloud-sql-proxy --port 5432 ${{ secrets.CLOUD_SQL_CONNECTION_NAME }} &
          PROXY_PID=$!
          echo "PROXY_PID=$PROXY_PID" >> $GITHUB_ENV
          
          # Wait for proxy to be ready with proper connection testing
          echo "Waiting for Cloud SQL Proxy to be ready..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if pg_isready -h localhost -p 5432 -U postgres > /dev/null 2>&1; then
              echo "✓ Cloud SQL Proxy is ready!"
              break
            fi
            attempt=$((attempt + 1))
            if [ $attempt -eq $max_attempts ]; then
              echo "✗ Timeout waiting for Cloud SQL Proxy"
              kill $PROXY_PID || true
              exit 1
            fi
            echo "Attempt $attempt/$max_attempts - waiting..."
            sleep 2
          done
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth-gcloud.outputs.credentials_file_path }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: backend/yarn.lock
      
      - name: Install dependencies
        working-directory: ./backend
        run: yarn install --frozen-lockfile
      
      - name: Run Database Migrations
        working-directory: ./backend
        run: |
          echo "Running Prisma migrations..."
          yarn prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_LOCAL_PROXY }}
      
      - name: Stop Cloud SQL Proxy
        if: always()
        run: |
          if [ ! -z "$PROXY_PID" ]; then
            kill $PROXY_PID || true
          fi
           
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          image: ${{ env.BE_FULL_IMAGE_PATH }}
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          flags: '--port=8080 --allow-unauthenticated --add-cloudsql-instances=${{ secrets.CLOUD_SQL_CONNECTION_NAME }}'
          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
